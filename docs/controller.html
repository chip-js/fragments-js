<!DOCTYPE html>

<html>
<head>
  <title>Chip Controller</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="chip-controller">Chip Controller</h1>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>A Controller is the object to which HTML elements are bound.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Controller</span></span>

  <span class="hljs-attribute">constructor</span>: <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Creates the observer array so child controllers don’t inherit this from parents</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@_observers</span> = []
    <span class="hljs-property">@_children</span> = []
    <span class="hljs-property">@_syncListeners</span> = []
    <span class="hljs-property">@_closed</span> = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Watches an expression for changes. Calls the <code>callback</code> immediately with the initial value and then every time
the value in the expression changes. An expression can be as simple as <code>name</code> or as complex as
<code>user.firstName + &#39; &#39; + user.lastName + &#39; - &#39; + user.getPostfix()</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">watch</span>: <span class="hljs-function"><span class="hljs-params">(expr, skipTriggerImmediately, callback)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> Array.isArray(expr)
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> skipTriggerImmediately <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
        callback = skipTriggerImmediately
        skipTriggerImmediately = <span class="hljs-literal">false</span>

      origCallback = callback
      calledThisRound = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>with multiple observers, only call the original callback once on change</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">      <span class="hljs-title">callback</span> = -&gt;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> calledThisRound
        calledThisRound = <span class="hljs-literal">true</span>
        setTimeout -&gt; calledThisRound = <span class="hljs-literal">false</span>
        values = observers.map (observer) -&gt; observer.getter()
        origCallback values...

      observers = expr.map (expr) =&gt;
        <span class="hljs-property">@watch</span>(expr, <span class="hljs-literal">true</span>, callback)

      <span class="hljs-keyword">unless</span> skipTriggerImmediately
        callback()

      <span class="hljs-keyword">return</span> observers

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> expr <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
      getter = expr
    <span class="hljs-keyword">else</span>
      getter = expression.bind(expr, <span class="hljs-keyword">this</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Store the observers with the controller so when it is closed we can clean up all observers as well</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    observer = Observer.add getter, skipTriggerImmediately, callback
    observer.expr = expr
    <span class="hljs-property">@_observers</span>.push observer
    observer</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Stop watching an expression for changes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">unwatch</span>: <span class="hljs-function"><span class="hljs-params">(expr, callback)</span> -&gt;</span>
    <span class="hljs-property">@_observers</span>.some (observer, index) =&gt;
      <span class="hljs-keyword">if</span> observer.expr <span class="hljs-keyword">is</span> expr <span class="hljs-keyword">and</span> observer.callback <span class="hljs-keyword">is</span> callback
        observer.close()
        <span class="hljs-property">@_observers</span>.splice index, <span class="hljs-number">1</span>
        <span class="hljs-literal">true</span>
      <span class="hljs-keyword">else</span>
        <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Evaluates an expression immediately, returning the result</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">eval</span>: <span class="hljs-function"><span class="hljs-params">(expr, args)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> args
      options = <span class="hljs-attribute">args</span>: Object.keys(args)
      values = options.args.map (key) -&gt; args[key]
    expression.get(expr, options).apply(<span class="hljs-keyword">this</span>, values)</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Evaluates an expression immediately as a setter, setting <code>value</code> to the expression running through filters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">evalSetter</span>: <span class="hljs-function"><span class="hljs-params">(expr, value)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-property">@passthrough</span>().evalSetter(expr, value) <span class="hljs-keyword">if</span> <span class="hljs-property">@passthrough</span>() <span class="hljs-keyword">isnt</span> <span class="hljs-keyword">this</span>
    expr = expr.replace(<span class="hljs-regexp">/(\s*\||$)/</span>, <span class="hljs-string">' = value$1'</span>)
    expression.get(expr, <span class="hljs-attribute">args</span>: [<span class="hljs-string">'value'</span>]).call(<span class="hljs-keyword">this</span>, value)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Creates a bound function which can be called any time to evaluate the expession. <code>extraArgNames</code> can be provided
to provide for additional data to be passed into the returned function.</p>
<p><strong>Example:</strong></p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> expr = <span class="hljs-string">'name = firstName + \' \' + lastName'</span>
<span class="hljs-keyword">var</span> setName = controller.getBoundEval(expr, <span class="hljs-string">'firstName'</span>, <span class="hljs-string">'lastName'</span>)
setName(<span class="hljs-string">'Jacob'</span>, <span class="hljs-string">'Wright'</span>)
<span class="hljs-built_in">console</span>.log(controller.name) <span class="hljs-comment">// equals "Jacob Wright"</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getBoundEval</span>: <span class="hljs-function"><span class="hljs-params">(expr, extraArgNames...)</span> -&gt;</span>
    expression.bind(expr, <span class="hljs-keyword">this</span>, <span class="hljs-attribute">args</span>: extraArgNames)</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Redirects to the provided URL</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">redirect</span>: <span class="hljs-function"><span class="hljs-params">(url, replace = <span class="hljs-literal">false</span>)</span> -&gt;</span>
    <span class="hljs-property">@app</span>.redirect(url, replace)
    <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Clones the object at the given property name for processing forms</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">cloneValue</span>: <span class="hljs-function"><span class="hljs-params">(property)</span> -&gt;</span>
    diff.clone @[property]</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Removes and closes all observers for garbage-collection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">closeController</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@_closed</span>
    <span class="hljs-property">@_closed</span> = <span class="hljs-literal">true</span>

    <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> <span class="hljs-property">@_children</span>
      child._parent = <span class="hljs-literal">null</span>
      child.closeController()
    <span class="hljs-keyword">if</span> <span class="hljs-property">@_parent</span>?._children
      index = <span class="hljs-property">@_parent</span>._children.indexOf <span class="hljs-keyword">this</span>
      <span class="hljs-property">@_parent</span>._children.splice(index, <span class="hljs-number">1</span>) <span class="hljs-keyword">if</span> index <span class="hljs-keyword">isnt</span> -<span class="hljs-number">1</span>
    <span class="hljs-property">@_parent</span> = <span class="hljs-literal">null</span>

    <span class="hljs-property">@beforeClose</span>() <span class="hljs-keyword">if</span> <span class="hljs-property">@hasOwnProperty</span>(<span class="hljs-string">'beforeClose'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-property">@_syncListeners</span>
      <span class="hljs-keyword">for</span> listener <span class="hljs-keyword">in</span> <span class="hljs-property">@_syncListeners</span>
        Observer.removeOnSync listener
      <span class="hljs-keyword">delete</span> <span class="hljs-property">@_syncListeners</span>

    <span class="hljs-keyword">for</span> observer <span class="hljs-keyword">in</span> <span class="hljs-property">@_observers</span>
      observer.close()
    <span class="hljs-property">@_observers</span>.length = <span class="hljs-number">0</span>
    <span class="hljs-property">@onClose</span>() <span class="hljs-keyword">if</span> <span class="hljs-property">@hasOwnProperty</span>(<span class="hljs-string">'onClose'</span>)
    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Syncs the observers to propogate changes to the HTML, call callback after</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">sync</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
    Observer.sync(callback)
    <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Runs the sync on the next tick, call callback after</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">syncLater</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
    Observer.syncLater(callback)
    <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Syncs the observers to propogate changes to the HTML for this controller only</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">syncThis</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-property">@_observers</span>.forEach (observer) -&gt;
      observer.sync()
    <span class="hljs-property">@_children</span>.forEach (child) -&gt;
      child.syncThis()
    <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>call callback after the current sync</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">afterSync</span>: <span class="hljs-function"><span class="hljs-params">(callback)</span> -&gt;</span>
    Observer.afterSync callback
    <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Runs the listener on every sync, stops once the controller is closed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">onSync</span>: <span class="hljs-function"><span class="hljs-params">(listener)</span> -&gt;</span>
    <span class="hljs-property">@_syncListeners</span>.push listener
    Observer.onSync(listener)
    <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Removes a sync listener</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">removeOnSync</span>: <span class="hljs-function"><span class="hljs-params">(listener)</span> -&gt;</span>
    index = <span class="hljs-property">@_syncListeners</span>.indexOf listener
    <span class="hljs-property">@_syncListeners</span>.splice(index, <span class="hljs-number">1</span>) <span class="hljs-keyword">unless</span> index <span class="hljs-keyword">is</span> -<span class="hljs-number">1</span>
    Observer.removeOnSync(listener)
    <span class="hljs-keyword">this</span>


  <span class="hljs-attribute">passthrough</span>: <span class="hljs-function"><span class="hljs-params">(value)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> arguments.length
      <span class="hljs-property">@_passthrough</span> = value
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">if</span> <span class="hljs-property">@hasOwnProperty</span>(<span class="hljs-string">'_passthrough'</span>) <span class="hljs-keyword">then</span> <span class="hljs-property">@_passthrough</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>jQuery plugin to get the controller for the given element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>$.fn.controller = <span class="hljs-function"><span class="hljs-params">(passthrough)</span> -&gt;</span>
  element = <span class="hljs-keyword">this</span>
  <span class="hljs-keyword">while</span> element.length
    controller = element.data(<span class="hljs-string">'controller'</span>)
    <span class="hljs-keyword">if</span> controller
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> passthrough <span class="hljs-keyword">then</span> controller.passthrough() <span class="hljs-keyword">else</span> controller
    element = element.parent()
  <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Provides the ‘remove’ event to be dispatched when an element is removed from the DOM and cleaned up. Gets
called when an element with the event ‘remove’, is removed from the DOM. Manually call the listener.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">unless</span> $.widget
  $.cleanData = <span class="hljs-function">(<span class="hljs-params">(orig)</span> -&gt;</span>
    (elems) -&gt;
      <span class="hljs-keyword">for</span> elem <span class="hljs-keyword">in</span> elems
        <span class="hljs-keyword">try</span>
          $(elem).triggerHandler(<span class="hljs-string">'remove'</span>)
        <span class="hljs-keyword">catch</span> e
      orig elems
  )($.cleanData)


chip.Controller = Controller</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
